#include "keyExpansion.h"

const unsigned int Rcon[][4] = { //TODO: Determine type
   { 0x00, 0x00, 0x00, 0x00 }, // Rcon[] is 1-based, so the first entry is just a place holder
   { 0x01, 0x00, 0x00, 0x00 }, 
   { 0x02, 0x00, 0x00, 0x00 }, 
   { 0x04, 0x00, 0x00, 0x00 }, 
   { 0x08, 0x00, 0x00, 0x00 },
   { 0x10, 0x00, 0x00, 0x00 }, 
   { 0x20, 0x00, 0x00, 0x00 }, 
   { 0x40, 0x00, 0x00, 0x00 }, 
   { 0x80, 0x00, 0x00, 0x00 },
   { 0x1B, 0x00, 0x00, 0x00 }, 
   { 0x36, 0x00, 0x00, 0x00 }, 
   { 0x6C, 0x00, 0x00, 0x00 }, 
   { 0xD8, 0x00, 0x00, 0x00 },
   { 0xAB, 0x00, 0x00, 0x00 }, 
   { 0x4D, 0x00, 0x00, 0x00 }, 
   { 0x9A, 0x00, 0x00, 0x00 }, 
   { 0x2F, 0x00, 0x00, 0x00 },
   { 0x5E, 0x00, 0x00, 0x00 }, 
   { 0xBC, 0x00, 0x00, 0x00 }, 
   { 0x63, 0x00, 0x00, 0x00 }, 
   { 0xC6, 0x00, 0x00, 0x00 },
   { 0x97, 0x00, 0x00, 0x00 }, 
   { 0x35, 0x00, 0x00, 0x00 }, 
   { 0x6A, 0x00, 0x00, 0x00 }, 
   { 0xD4, 0x00, 0x00, 0x00 },
   { 0xB3, 0x00, 0x00, 0x00 }, 
   { 0x7D, 0x00, 0x00, 0x00 }, 
   { 0xFA, 0x00, 0x00, 0x00 }, 
   { 0xEF, 0x00, 0x00, 0x00 },
   { 0xC5, 0x00, 0x00, 0x00 }, 
   { 0x91, 0x00, 0x00, 0x00 }, 
   { 0x39, 0x00, 0x00, 0x00 }, 
   { 0x72, 0x00, 0x00, 0x00 },
   { 0xE4, 0x00, 0x00, 0x00 }, 
   { 0xD3, 0x00, 0x00, 0x00 }, 
   { 0xBD, 0x00, 0x00, 0x00 }, 
   { 0x61, 0x00, 0x00, 0x00 },
   { 0xC2, 0x00, 0x00, 0x00 }, 
   { 0x9F, 0x00, 0x00, 0x00 }, 
   { 0x25, 0x00, 0x00, 0x00 }, 
   { 0x4A, 0x00, 0x00, 0x00 },
   { 0x94, 0x00, 0x00, 0x00 }, 
   { 0x33, 0x00, 0x00, 0x00 }, 
   { 0x66, 0x00, 0x00, 0x00 }, 
   { 0xCC, 0x00, 0x00, 0x00 },
   { 0x83, 0x00, 0x00, 0x00 }, 
   { 0x1D, 0x00, 0x00, 0x00 }, 
   { 0x3A, 0x00, 0x00, 0x00 }, 
   { 0x74, 0x00, 0x00, 0x00 },
   { 0xE8, 0x00, 0x00, 0x00 }, 
   { 0xCB, 0x00, 0x00, 0x00 }, 
   { 0x8D, 0x00, 0x00, 0x00 }
    };

void subWord(word w)
{
    BYTE SRow, SColumn;

    for(int row = 0; row < 4; row++)
    {
        SRow = w[row] >> 4;
        SColumn = (w[row] | 0xf0) ^ 0xf0;

        w[row] = Sbox[SRow][SColumn];
    }
}

void rotWord(word w)
{
    word oldWord;

    for(int row = 0; row < 4; row++)
    {
        oldWord[row] = w[row];
    }

    for(int row = 0; row < 4; row++)
    {
        w[row] = oldWord[(row + 1) % 4];
    }
}

void keyExpansion(BYTE key[], word w[], keyLength currentKeyLength)
{
    word temp;

    int column;

    for (column = 0; column < Nk[currentKeyLength]; column++)
    {
        for(int row = 0; row < 4; row++)
        {
            w[column][row] = key[(4*column) + row];
        }
    }

    for (column = Nk[currentKeyLength]; column < Nb * (Nr[currentKeyLength] + 1); column++)
    {
        for(int row = 0; row < 4; row++)
        {
            temp[row] = w[column - 1][row];
        }

        if((column % Nk[currentKeyLength]) == 0)
        {
            rotWord(temp);   
            subWord(temp);
            
            for(int row = 0; row < 4; row++)
            {
                temp[row] ^= Rcon[(column/Nk[currentKeyLength])][row];
            }
        }
        else if ((Nk[currentKeyLength] > Nk[KL192]) && (column % Nk[currentKeyLength] == 4))
        {
            subWord(temp);
        }

        for(int row = 0; row < 4; row++)
        {
            w[column][row] = (w[column - Nk[currentKeyLength]][row] ^ temp[row]);
        }
    }
}